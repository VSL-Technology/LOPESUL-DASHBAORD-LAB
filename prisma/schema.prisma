generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Operador {
  role     String?
  id       String   @id @default(uuid())
  nome     String   @unique @map("usuario")
  senha    String
  ativo    Boolean  @default(true)
  criadoEm DateTime @default(now()) @map("createdAt")

  @@map("operadores")
}

model Frota {
  id           String        @id @default(uuid())
  criadoEm     DateTime      @default(now()) @map("createdAt")
  nome         String?
  placa        String?
  rotaLinha    String?
  status       FrotaStatus   @default(ATIVO)
  observacoes  String?
  roteadorId   String?       @unique
  dispositivos Dispositivo[]
  roteador     Roteador?     @relation(fields: [roteadorId], references: [id])
  vendas       Venda[]

  @@index([criadoEm])
}

model Venda {
  id        String   @id @default(uuid())
  frotaId   String
  data      DateTime @default(now())
  valorCent Int
  frota     Frota    @relation(fields: [frotaId], references: [id], onDelete: Cascade)

  @@index([frotaId, data])
}

model Dispositivo {
  id             String        @id @default(uuid())
  criadoEm       DateTime      @default(now()) @map("createdAt")
  frotaId        String
  atualizadoEm   DateTime      @updatedAt
  ip             String        @db.Inet
  mikId          String?       @unique
  mikrotikHost   String?
  mikrotikUser   String?
  mikrotikPass   String?
  mikrotikPort   Int           @default(8728)
  mikrotikUseSsl Boolean       @default(false)
  frota          Frota         @relation(fields: [frotaId], references: [id], onDelete: Cascade)
  pedidos        Pedido[]
  clientTokens   ClientToken[]

  @@unique([frotaId, ip])
  @@index([ip])
}

model Roteador {
  id              String         @id @default(cuid())
  nome            String
  identity        String?        @unique
  ipLan           String
  usuario         String
  senhaHash       String
  portaApi        Int            @default(8728)
  portaSsh        Int            @default(22)
  wgPublicKey     String?
  wgIp            String?
  statusMikrotik  RoteadorStatus @default(DESCONHECIDO)
  statusWireguard RoteadorStatus @default(DESCONHECIDO)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  frota           Frota?
  sessoes         SessaoAtiva[]
}

model SessaoAtiva {
  id         String    @id @default(cuid())
  ipCliente  String    @unique
  macCliente String?
  plano      String
  inicioEm   DateTime  @default(now())
  expiraEm   DateTime
  ativo      Boolean   @default(true)
  pedidoId   String?
  roteadorId String?
  pedido     Pedido?   @relation(fields: [pedidoId], references: [id])
  roteador   Roteador? @relation(fields: [roteadorId], references: [id])

  @@index([ativo])
  @@index([pedidoId])
  @@index([roteadorId])
  @@map("sessoes_ativas")
}

model Config {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Pedido {
  id               String        @id @default(cuid())
  code             String        @unique
  amount           Int
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)
  description      String?
  deviceMac        String?
  ip               String?       @db.Inet
  busId            String?
  customerName     String?
  customerEmail    String?
  customerDoc      String?
  metadata         Json?
  processedAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deviceId         String?
  deviceIdentifier String?
  charges          Charge[]
  device           Dispositivo?  @relation(fields: [deviceId], references: [id])
  clientTokens     ClientToken[]
  SessaoAtiva      SessaoAtiva[]

  @@index([status, createdAt])
  @@index([method, createdAt])
  @@index([status, processedAt])
  @@index([deviceId])
}

model Charge {
  id         String        @id @default(cuid())
  pedidoId   String
  providerId String?
  status     ChargeStatus  @default(CREATED)
  method     PaymentMethod
  qrCode     String?
  qrCodeUrl  String?
  raw        Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  pedido     Pedido        @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([pedidoId])
  @@index([status, createdAt])
  @@index([providerId])
}

model ClientToken {
  id         String       @id @default(cuid())
  token      String       @unique
  pedidoId   String
  deviceId   String?
  ipInicial  String?      @db.Inet
  macInicial String?
  expiresAt  DateTime
  createdAt  DateTime     @default(now())
  device     Dispositivo? @relation(fields: [deviceId], references: [id])
  pedido     Pedido       @relation(fields: [pedidoId], references: [id])

  @@index([pedidoId])
  @@map("client_tokens")
}

model SessaoPagamento {
  token        String    @id
  identity     String
  macInicial   String?
  ipInicial    String?
  planoId      String?
  planoMinutos Int?
  status       String    @default("PENDING")
  chargeId     String?
  orderId      String?
  createdAt    DateTime  @default(now())
  paidAt       DateTime?
  expiresAt    DateTime?
  lastSeenMac  String?
  lastSeenIp   String?

  @@map("sessao_pagamento")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  username  String
  ip        String
  success   Boolean
  createdAt DateTime @default(now())

  @@index([username, createdAt])
  @@index([ip, createdAt])
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String?
  orderCode String?
  payload   Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([event])
}

model AuditLog {
  id        String   @id @default(cuid())
  requestId String
  event     String
  actorId   String?
  ip        String?
  entityId  String?
  result    String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([requestId])
  @@index([createdAt])
  @@index([event])
  @@map("audit_log")
}

enum FrotaStatus {
  ATIVO
  INATIVO
  MANUTENCAO
}

enum RoteadorStatus {
  DESCONHECIDO
  ONLINE
  OFFLINE
  ERRO
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELED
  EXPIRED
}

enum PaymentMethod {
  PIX
  CARD
  BOLETO
}

enum ChargeStatus {
  CREATED
  AUTHORIZED
  PAID
  REFUNDED
  FAILED
  CANCELED
}
